# Ingress para acceso externo a la API y Frontend
# k3s viene con Traefik por defecto

apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: langchain-ingress
  namespace: llm-services
  labels:
    app.kubernetes.io/part-of: langchain-ollama
  annotations:
    # Traefik annotations
    traefik.ingress.kubernetes.io/router.entrypoints: web,websecure
    # Aumentar timeout para streaming
    traefik.ingress.kubernetes.io/router.middlewares: llm-services-llm-services-timeout@kubernetescrd,llm-services-authelia@kubernetescrd
    # SSL / Cert Manager
    cert-manager.io/cluster-issuer: letsencrypt-prod

spec:
  ingressClassName: traefik  # Clase de ingress de k3s
  tls:
  - hosts:
    - northr3nd.duckdns.org
    secretName: langchain-tls
  rules:
  - host: northr3nd.duckdns.org
    http:
      paths:
      # Frontend App (incluye proxy a API en /ia/chat/api/)
      - path: /ia/chat
        pathType: Prefix
        backend:
          service:
            name: langchain-frontend
            port:
              number: 80

---
apiVersion: traefik.containo.us/v1alpha1
kind: Middleware
metadata:
  name: llm-services-timeout
  namespace: llm-services
spec:
  # Configurar timeouts si es necesario, o un middleware vacio/pass-through si solo es para probar
  # Pero ya que lo usamos, intentemos configurar algo util o simplemente un headers middleware seguro
  headers:
    customRequestHeaders:
      X-Forwarded-Proto: "https"

---
apiVersion: traefik.containo.us/v1alpha1
kind: Middleware
metadata:
  name: authelia
  namespace: llm-services
spec:
  forwardAuth:
    address: http://authelia.authelia.svc.cluster.local/api/verify?rd=https://auth.northr3nd.duckdns.org
    trustForwardHeader: true
    authResponseHeaders:
      - Remote-User
      - Remote-Groups
      - Remote-Name
      - Remote-Email
